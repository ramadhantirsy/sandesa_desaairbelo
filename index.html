<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width"
    />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />

    <!-- Leaflet & qgis2web CSS -->
    <link rel="stylesheet" href="css/leaflet.css" />
    <link rel="stylesheet" href="css/L.Control.Layers.Tree.css" />
    <link rel="stylesheet" href="css/qgis2web.css" />
    <link rel="stylesheet" href="css/fontawesome-all.min.css" />
    <link rel="stylesheet" href="css/leaflet.photon.css" />
    <link rel="stylesheet" href="css/leaflet-measure.css" />

    <style>
      html, body, #map {
        width: 100%;
        height: 100%;
        padding: 0;
        margin: 0;
      }
    </style>

    <link href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@700&display=swap" rel="stylesheet" />

    <style>
      /* --- JUDUL --- */
      #judul-container {
        position: absolute;
        top: 20px;
        left: 50px;
        display: flex;
        align-items: center;
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(5px);
        padding: 5px 15px 5px 10px;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        z-index: 999999;
        animation: fadeInSoft 2s ease-out;
      }
      #logo-desa {
        height: 60px;
        object-fit: contain;
        margin-right: 10px;
      }
      #judul-animasi {
        font-family: 'Poppins', sans-serif;
        font-size: 30px;
        font-weight: bold;
        color: #2c3e50;
        margin: 0;
      }
      @media (max-width: 768px) {
        #judul-container { left: 10px; padding: 8px 20px; top: 10px; }
        #judul-animasi { font-size: 20px; }
        #logo-desa { height: 40px; }
      }

      /* --- TOGGLE --- */
      .toggle-button {
        position: absolute;
        top: 80px;
        right: 20px;
        z-index: 99999;
        background: orange;
        padding: 10px 18px;
        border-radius: 10px;
        font-size: 14px;
        cursor: pointer;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        font-family: 'Poppins', sans-serif;
        font-weight: bold;
        color: #fff;
        border: none;
      }

      /* --- PANEL INFO --- */
      #info-box {
        position: absolute;
        top: 130px;
        right: 20px;
        width: 280px;
        background: rgba(255, 255, 255, 0.75);
        border-radius: 12px;
        padding: 15px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        z-index: 9997;
        display: none;
        backdrop-filter: blur(6px);
        font-family: 'Poppins', sans-serif;
      }
      #info-box h3 {
        margin-top: 0;
        font-size: 16px;
        color: #2c3e50;
      }

      .stat-container { margin-top: 10px; }
      .stat-header {
        background: rgba(17, 63, 103, 0.8);
        padding: 6px 12px;
        border-radius: 20px;
        text-align: center;
        font-weight: bold;
        font-size: 14px;
        margin-bottom: 12px;
        color: #fff;
      }
      .stat-box {
        background: rgba(17, 63, 103, 0.8);
        border-radius: 10px;
        padding: 12px;
        margin-bottom: 10px;
        text-align: center;
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
      }
      .stat-value { font-size: 24px; font-weight: bold; color: #fff; }
      .stat-label { font-size: 13px; color: #fff; margin-top: 4px; }

      /* --- TAB KATEGORI CHART --- */
      .category-buttons {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        margin: 12px 0 6px;
      }
      .category-buttons button {
        padding: 8px 10px;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        background: #e9eef9;
        color: #2c3e50;
        font-weight: 600;
        font-size: 12px;
      }
      .category-buttons button.active {
        background: #2563eb;
        color: #fff;
      }
      .chart-wrap { padding: 8px 6px; }
      canvas { max-width: 100%; }
    </style>

    <title></title>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <div id="map"></div>

    <div id="judul-container">
      <img id="logo-desa" src="img/logo_desa.png" alt="Logo Desa" />
      <div id="judul-animasi">PETA TEMATIK DESA AIR BELO</div>
    </div>

    <button class="toggle-button" onclick="toggleInfo()">Tampilkan Visualisasi</button>

    <div id="info-box">
      <h3>Informasi Penduduk</h3>

      <div class="stat-container">
        <div class="stat-header">üìç Desa Air Belo</div>

        <div class="stat-box">
          <div class="stat-value" id="jumlah-penduduk">0</div>
          <div class="stat-label">Jumlah Penduduk Usia 15-64 Tahun dari 3,330 Total Penduduk</div>
        </div>

        <div class="stat-box">
          <div class="stat-value" id="persen-tambang">0%</div>
          <div class="stat-label">Lapangan Usaha Utama: Pertambangan/Penggalian</div>
        </div>
      </div>

      <!-- Tombol kategori chart -->
      <div class="category-buttons">
        <button id="btn-work"   onclick="showChart('work')">Kategori</button>
        <button id="btn-status" onclick="showChart('status')">Status Pekerjaan</button>
        <button id="btn-gender" onclick="showChart('gender')">Jenis Kelamin</button>
        <button id="btn-age"    onclick="showChart('age')">Kategori Umur</button>
      </div>

      <div class="chart-wrap">
        <canvas id="donutChart" width="240" height="240"></canvas>
      </div>
    </div>

    <!-- ===== Leaflet & qgis2web JS ===== -->
    <script src="js/qgis2web_expressions.js"></script>
    <script src="js/leaflet.js"></script>
    <script src="js/L.Control.Layers.Tree.min.js"></script>
    <script src="js/leaflet.rotatedMarker.js"></script>
    <script src="js/leaflet.pattern.js"></script>
    <script src="js/leaflet-hash.js"></script>
    <script src="js/Autolinker.min.js"></script>
    <script src="js/rbush.min.js"></script>
    <script src="js/labelgun.min.js"></script>
    <script src="js/labels.js"></script>
    <script src="js/leaflet.photon.js"></script>
    <script src="js/leaflet-measure.js"></script>
    <script src="data/AIRBELO_MENTOK_1.js"></script>

    <script>
      // ====== Map init (sesuai tampilan peta sebelumnya) ======
      var highlightLayer;
      function highlightFeature(e) {
        highlightLayer = e.target;
        if (
          e.target.feature.geometry.type === 'LineString' ||
          e.target.feature.geometry.type === 'MultiLineString'
        ) {
          highlightLayer.setStyle({ color: '#FCE7C8' });
        } else {
          highlightLayer.setStyle({ fillColor: '#FCE7C8', fillOpacity: 0.5 });
        }
        highlightLayer.openPopup();
      }

      var map = L.map('map', { zoomControl: false, maxZoom: 17, minZoom: 2 });
      var hash = new L.Hash(map);
      map.attributionControl.setPrefix(
        '<a href="https://github.com/tomchadwin/qgis2web" target="_blank">qgis2web</a> ¬∑ <a href="https://leafletjs.com">Leaflet</a> ¬∑ <a href="https://qgis.org">QGIS</a>'
      );

      L.control.zoom({ position: 'topleft' }).addTo(map);
      var measureControl = new L.Control.Measure({
        position: 'topleft',
        primaryLengthUnit: 'feet',
        secondaryLengthUnit: 'miles',
        primaryAreaUnit: 'sqfeet',
        secondaryAreaUnit: 'sqmiles'
      });
      measureControl.addTo(map);
      document.getElementsByClassName('leaflet-control-measure-toggle')[0].innerHTML = '';
      document.getElementsByClassName('leaflet-control-measure-toggle')[0].className += ' fas fa-ruler';

      var bounds_group = new L.featureGroup([]);
      function setBounds() {
        if (bounds_group.getLayers().length) {
          map.fitBounds(bounds_group.getBounds());
        }
      }

      map.createPane('pane_GoogleSatellite_0');
      map.getPane('pane_GoogleSatellite_0').style.zIndex = 400;
      var layer_GoogleSatellite_0 = L.tileLayer(
        'https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}',
        {
          pane: 'pane_GoogleSatellite_0',
          opacity: 1.0,
          attribution:
            '<a href="https://www.google.at/permissions/geoguidelines/attr-guide.html">Map data ¬©2015 Google</a>',
          minZoom: 2,
          maxZoom: 17,
          minNativeZoom: 0,
          maxNativeZoom: 20
        }
      );
      map.addLayer(layer_GoogleSatellite_0);

      function pop_AIRBELO_MENTOK_1(feature, layer) {
        layer.on({
          mouseout: function (e) {
            for (var i in e.target._eventParents) {
              if (typeof e.target._eventParents[i].resetStyle === 'function') {
                e.target._eventParents[i].resetStyle(e.target);
              }
            }
            if (typeof layer.closePopup == 'function') {
              layer.closePopup();
            } else {
              layer.eachLayer(function (feature) {
                feature.closePopup();
              });
            }
          },
          mouseover: highlightFeature
        });

        // === Popup: RT, Dusun, Sektor ===
        const getVal = (k) => (feature.properties?.[k] == null ? '' : String(feature.properties[k]));
        const rt = getVal('rt');
        const dusun = getVal('dusun');
        const sektor = getVal('sektor');

        var popupContent =
          '<table style="width:auto">' +
          '<tr><td style="font-weight:600;width:90px">RT</td><td>:</td><td>' + rt + '</td></tr>' +
          '<tr><td style="font-weight:600">Dusun</td><td>:</td><td>' + dusun + '</td></tr>' +
          '<tr><td style="font-weight:600">Sektor</td><td>:</td><td>' + sektor + '</td></tr>' +
          '</table>';

        layer.bindPopup(popupContent, { maxHeight: 400 });
      }

      function style_AIRBELO_MENTOK_1_0() {
        return {
          pane: 'pane_AIRBELO_MENTOK_1',
          opacity: 1,
          color: 'rgba(255,245,235,1.0)',
          dashArray: '10.0,2.0',
          lineCap: 'butt',
          lineJoin: 'miter',
          weight: 2.0,
          fill: true,
          fillOpacity: 1,
          fillColor: 'rgba(231,113,72,0.5137254901960784)',
          interactive: true
        };
      }

      map.createPane('pane_AIRBELO_MENTOK_1');
      map.getPane('pane_AIRBELO_MENTOK_1').style.zIndex = 401;
      map.getPane('pane_AIRBELO_MENTOK_1').style['mix-blend-mode'] = 'normal';
      var layer_AIRBELO_MENTOK_1 = new L.geoJson(json_AIRBELO_MENTOK_1, {
        attribution: '',
        interactive: true,
        dataVar: 'json_AIRBELO_MENTOK_1',
        layerName: 'layer_AIRBELO_MENTOK_1',
        pane: 'pane_AIRBELO_MENTOK_1',
        onEachFeature: pop_AIRBELO_MENTOK_1,
        style: style_AIRBELO_MENTOK_1_0
      });
      bounds_group.addLayer(layer_AIRBELO_MENTOK_1);
      map.addLayer(layer_AIRBELO_MENTOK_1);
      setBounds();
    </script>

    <!-- ===== Chart & Interaksi Panel ===== -->
    <script>
      // --------- DATA PER KATEGORI (silakan sesuaikan dengan data riil) ----------
      const chartData = {
        // 1) Kategori: Bekerja vs Tidak Bekerja
        work: {
          title: 'Bekerja / Tidak Bekerja',
          labels: ['Bekerja', 'Tidak Bekerja'],
          data: [1539, 1791],
          colors: ['#10b981', '#ef4444'] // hijau & merah
        },

        // 2) Status Pekerjaan (8 item)
        status: {
          title: 'Status Pekerjaan',
          labels: [
            'Berusaha sendiri',
            'Berusaha dibantu buruh tidak tetap',
            'Berusaha dibantu buruh tetap',
            'Buruh/karyawan/pegawai swasta',
            'PNS/TNI/POLRI/BUMN',
            'Pekerja bebas pertanian',
            'Pekerja bebas non pertanian',
            'Pekerja keluarga/tidak dibayar'
          ],
          data: [507, 128, 44, 627, 99, 3, 39, 92],
          colors: ['#3b82f6','#8b5cf6','#f59e0b','#22c55e','#06b6d4','#ef4444','#a855f7','#84cc16']
        },

        // 3) Jenis Kelamin
        gender: {
          title: 'Jenis Kelamin',
          labels: ['Laki-laki', 'Perempuan'],
          data: [1175, 1126],
          colors: ['#2563eb', '#ec4899']
        },

        // 4) Kategori Umur
        age: {
          title: 'Kategori Umur',
          labels: ['15-24', '25-34', '35-44', '45-54', '55-64'],
          data: [220, 269, 410, 370, 192],
          colors: ['#3b82f6', '#8b5cf6', '#ef4444', '#14b8a6', '#f97316']
        }
      };

      let chartInstance;

      // Tooltip: "Nama: jumlah (persen%)"
      function tooltipLabel(context) {
        const total = context.dataset.data.reduce((a, b) => a + b, 0);
        const value = context.raw;
        const pct = total ? ((value / total) * 100).toFixed(1) : 0;
        const name = context.label || '';
        return `${name}: ${value.toLocaleString()} (${pct}%)`;
      }

      function buildChart(key) {
        const cfg = chartData[key];
        const ctx = document.getElementById('donutChart').getContext('2d');
        if (chartInstance) chartInstance.destroy();

        chartInstance = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: cfg.labels,
            datasets: [
              { data: cfg.data, backgroundColor: cfg.colors, hoverOffset: 4 }
            ]
          },
          options: {
            responsive: true,
            cutout: '50%',
            plugins: {
              legend: { display: false },  // legend dimatikan sesuai permintaan
              tooltip: {
                callbacks: { label: tooltipLabel }
              },
              title: { display: false }
            }
          }
        });

        // tandai tombol aktif
        document.querySelectorAll('.category-buttons button').forEach(b => b.classList.remove('active'));
        const mapBtn = { work: '#btn-work', status: '#btn-status', gender: '#btn-gender', age: '#btn-age' }[key];
        document.querySelector(mapBtn).classList.add('active');
      }

      // Animasi angka kotak
      function animateValue(id, start, end, duration, suffix = '') {
        const obj = document.getElementById(id);
        let startTimestamp = null;
        const step = (ts) => {
          if (!startTimestamp) startTimestamp = ts;
          const p = Math.min((ts - startTimestamp) / duration, 1);
          const val = suffix === '%' ? (p * (end - start) + start).toFixed(2) : Math.floor(p * (end - start) + start);
          obj.innerHTML = Number(val).toLocaleString() + suffix;
          if (p < 1) requestAnimationFrame(step);
        };
        requestAnimationFrame(step);
      }

      // Toggle panel
      function toggleInfo() {
        const box = document.getElementById('info-box');
        const btn = document.querySelector('.toggle-button');
        const visible = box.style.display === 'block';
        box.style.display = visible ? 'none' : 'block';
        btn.innerText = visible ? 'Tampilkan Visualisasi' : 'Sembunyikan Visualisasi';

        if (!visible) {
          // Default: tampilkan chart "work" (Bekerja/Tidak)
          buildChart('work');
          // Angka animasi contoh
          animateValue('jumlah-penduduk', 0, 2301, 1500);
          animateValue('persen-tambang', 0, 29.56, 1500, '%');
        }
      }

      // Klik tab kategori
      function showChart(key) { buildChart(key); }
    </script>
  </body>
</html>
